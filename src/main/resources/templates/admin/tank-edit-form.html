<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <th:block th:replace="~{/layouts/base :: head(${title})}"></th:block>
    <body>
        <div th:replace="~{/layouts/base :: header}"></div>
        <div th:replace="~{/layouts/base :: navbar}"></div>

        <main>
            <div class="container">
                <h1 th:text="${title}">Edit Tank</h1>

                <!-- Flash Messages -->
                <div th:if="${error}" class="alert alert-error">
                    <span th:text="${error}">Error message</span>
                </div>

                <!-- Current Tank Info -->
                <div class="info-box">
                    <h3>Current Information</h3>
                    <div class="info-grid">
                        <div>
                            <strong>Label:</strong>
                            <span th:text="${tank.label}">FV-1</span>
                        </div>
                        <div>
                            <strong>Capacity:</strong>
                            <span th:text="${#numbers.formatDecimal(tank.capacity, 1, 0)}">100</span>
                            <span>gals</span>
                        </div>
                        <div>
                            <strong>Current Quantity:</strong>
                            <span th:text="${#numbers.formatDecimal(tank.currentQuantity, 1, 0)}">90</span>
                            <span>gals</span>
                        </div>
                        <div>
                            <strong>Status:</strong>
                            <span th:if="${tank.currentBatchId != null}" class="badge badge-active">Active (Batch #<span th:text="${tank.currentBatchId}">1</span>)</span>
                            <span th:if="${tank.currentBatchId == null}" class="badge badge-empty">Empty</span>
                        </div>
                    </div>
                </div>

                <div class="form-container">
                    <form th:action="@{/admin/tanks/{label}/update(label=${tank.label})}" method="post">
                        <p class="form-note">Leave fields blank to keep current values. Only update what you want to change.</p>

                        <div class="form-group">
                            <label for="newLabel">New Tank Label (optional)</label>
                            <input type="text"
                                   id="newLabel"
                                   name="newLabel"
                                   pattern="[a-zA-Z0-9_-]+"
                                   th:placeholder="${tank.label}"
                                   th:attr="data-current-label=${tank.label}"
                                   title="Only letters, numbers, hyphens, and underscores allowed"
                                   oninput="validateForm()">
                            <small class="form-help">URL-safe name (e.g., FV-1, FV-2A, Fermenter-01)</small>
                            <small class="form-error" id="labelError" style="display: none;"></small>
                        </div>

                        <div class="form-group">
                            <label for="newCapacity">New Capacity (gallons) (optional)</label>
                            <input type="number"
                                   id="newCapacity"
                                   name="newCapacity"
                                   step="10"
                                   min="0"
                                   th:attr="data-current-capacity=${tank.capacity},
                                            data-current-quantity=${tank.currentQuantity}"
                                   th:placeholder="${#numbers.formatDecimal(tank.capacity, 1, 0)}"
                                   oninput="validateForm()">
                            <small class="form-help warning" th:if="${tank.currentQuantity > 0}">
                                ⚠️ Minimum capacity: <span th:text="${#numbers.formatDecimal(tank.currentQuantity, 1, 2)}">90.00</span>
                                <span>gals</span>
                                (current quantity)
                            </small>
                            <small class="form-error" id="capacityError" style="display: none;"></small>
                        </div>

                        <div class="form-actions">
                            <button type="submit" id="submitBtn" class="btn btn-primary" disabled>Update Tank</button>
                            <a th:href="@{/admin/tanks}" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </main>

        <style>
            .info-box {
                background-color: #f8f9fa;
                border: 2px solid #ecf0f1;
                border-radius: 8px;
                padding: 1.5rem;
                margin: 1.5rem 0;
            }

            .info-box h3 {
                margin-top: 0;
                margin-bottom: 1rem;
                color: #2c3e50;
            }

            .info-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
            }

            .info-grid strong {
                display: block;
                color: #7f8c8d;
                font-size: 0.85rem;
                margin-bottom: 0.25rem;
            }

            .form-container {
                max-width: 600px;
                margin: 2rem 0;
            }

            .form-note {
                background-color: #d1ecf1;
                border: 1px solid #bee5eb;
                color: #0c5460;
                padding: 1rem;
                border-radius: 6px;
                margin-bottom: 1.5rem;
            }

            .form-group {
                margin-bottom: 1.5rem;
            }

            .form-group label {
                display: block;
                margin-bottom: 0.5rem;
                font-weight: 600;
                color: #2c3e50;
            }

            .form-group input,
            .form-group select {
                width: 100%;
                padding: 0.75rem;
                border: 2px solid #ecf0f1;
                border-radius: 6px;
                font-size: 1rem;
                transition: border-color 0.2s ease;
            }

            .form-group input:focus,
            .form-group select:focus {
                outline: none;
                border-color: #1abc9c;
            }

            .form-help {
                display: block;
                margin-top: 0.5rem;
                font-size: 0.85rem;
                color: #7f8c8d;
            }

            .form-help.warning {
                color: #e67e22;
                font-weight: 500;
            }

            .form-error {
                display: block;
                margin-top: 0.5rem;
                font-size: 0.85rem;
                color: #e74c3c;
                font-weight: 600;
            }

            .form-group input.invalid {
                border-color: #e74c3c;
            }

            .form-group input.valid {
                border-color: #27ae60;
            }

            .btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .form-actions {
                display: flex;
                gap: 1rem;
                margin-top: 2rem;
            }

            .alert {
                padding: 1rem;
                border-radius: 6px;
                margin-bottom: 1rem;
            }

            .alert-error {
                background-color: #f8d7da;
                border: 1px solid #f5c6cb;
                color: #721c24;
            }

            .badge {
                display: inline-block;
                padding: 0.25rem 0.75rem;
                border-radius: 12px;
                font-size: 0.85rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .badge-active {
                background-color: #27ae60;
                color: white;
            }

            .badge-empty {
                background-color: #95a5a6;
                color: white;
            }
        </style>

        <script>
            // Validation function
            function validateForm() {
                const newLabelInput = document.getElementById('newLabel');
                const newCapacityInput = document.getElementById('newCapacity');
                const submitBtn = document.getElementById('submitBtn');
                const labelError = document.getElementById('labelError');
                const capacityError = document.getElementById('capacityError');

                // Get current values from data attributes
                const currentLabel = newLabelInput.getAttribute('data-current-label');
                const currentCapacity = parseFloat(newCapacityInput.getAttribute('data-current-capacity'));
                const currentQuantity = parseFloat(newCapacityInput.getAttribute('data-current-quantity'));

                // Get new values from inputs
                const newLabel = newLabelInput.value.trim();
                const newCapacity = newCapacityInput.value ? parseFloat(newCapacityInput.value) : null;

                let labelValid = false;
                let capacityValid = false;
                let hasChanges = false;

                // Validate Label
                if (newLabel === '') {
                    // Empty is okay (optional field)
                    newLabelInput.classList.remove('valid', 'invalid');
                    labelError.style.display = 'none';
                    labelValid = true; // Empty is valid, just no change
                } else {
                    // Check if different from current
                    if (newLabel === currentLabel) {
                        newLabelInput.classList.remove('valid');
                        newLabelInput.classList.add('invalid');
                        labelError.textContent = '❌ New label must be different from current label';
                        labelError.style.display = 'block';
                        labelValid = false;
                    }
                    // Check pattern
                    else if (!/^[a-zA-Z0-9_-]+$/.test(newLabel)) {
                        newLabelInput.classList.remove('valid');
                        newLabelInput.classList.add('invalid');
                        labelError.textContent = '❌ Only letters, numbers, hyphens, and underscores allowed';
                        labelError.style.display = 'block';
                        labelValid = false;
                    }
                    // Valid new label
                    else {
                        newLabelInput.classList.remove('invalid');
                        newLabelInput.classList.add('valid');
                        labelError.style.display = 'none';
                        labelValid = true;
                        hasChanges = true;
                    }
                }

                // Validate Capacity
                if (newCapacity === null || newCapacityInput.value === '') {
                    // Empty is okay (optional field)
                    newCapacityInput.classList.remove('valid', 'invalid');
                    capacityError.style.display = 'none';
                    capacityValid = true; // Empty is valid, just no change
                } else {
                    // Check if less than or equal to 0
                    if (newCapacity <= 0) {
                        newCapacityInput.classList.remove('valid');
                        newCapacityInput.classList.add('invalid');
                        capacityError.textContent = '❌ Capacity must be greater than 0';
                        capacityError.style.display = 'block';
                        capacityValid = false;
                    }
                    // Check if same as current
                    else if (newCapacity === currentCapacity) {
                        newCapacityInput.classList.remove('valid');
                        newCapacityInput.classList.add('invalid');
                        capacityError.textContent = '❌ New capacity must be different from current capacity';
                        capacityError.style.display = 'block';
                        capacityValid = false;
                    }
                    // Check if less than current quantity
                    else if (newCapacity < currentQuantity) {
                        newCapacityInput.classList.remove('valid');
                        newCapacityInput.classList.add('invalid');
                        capacityError.textContent = '❌ Capacity cannot be less than current quantity (' + currentQuantity.toFixed(2) + ' gals)';
                        capacityError.style.display = 'block';
                        capacityValid = false;
                    }
                    // Valid new capacity
                    else {
                        newCapacityInput.classList.remove('invalid');
                        newCapacityInput.classList.add('valid');
                        capacityError.style.display = 'none';
                        capacityValid = true;
                        hasChanges = true;
                    }
                }

                // Enable submit only if:
                // 1. At least one field has valid changes
                // 2. No validation errors
                if (hasChanges && labelValid && capacityValid) {
                    submitBtn.disabled = false;
                } else {
                    submitBtn.disabled = true;
                }
            }

            // Run validation on page load
            document.addEventListener('DOMContentLoaded', validateForm);
        </script>
    </body>
</html>
